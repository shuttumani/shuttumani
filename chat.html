<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Shuttumani üîí</title>
  <style>
    :root{
      --bg:#07070b; --card:rgba(255,255,255,.06); --stroke:rgba(255,255,255,.12);
      --txt:#f6f6f8; --mut:rgba(255,255,255,.65);
      --pink:#ff4da6; --pink2:#ff7ac2; --ok:#2cff73; --bad:#ff3b3b;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,Segoe UI,Roboto,Arial;
      color:var(--txt); min-height:100vh; display:grid; place-items:center; padding:18px;
      background:
        radial-gradient(900px 500px at 20% 10%, rgba(255,77,166,.18), transparent 55%),
        radial-gradient(700px 500px at 80% 20%, rgba(120,80,255,.16), transparent 55%),
        radial-gradient(900px 600px at 50% 90%, rgba(0,255,140,.08), transparent 55%),
        var(--bg);
    }
    .card{
      width:min(520px,100%);
      background:var(--card); border:1px solid var(--stroke);
      border-radius:18px; box-shadow:0 12px 40px rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
      padding:18px;
    }
    .top{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:12px}
    .brand{display:flex;align-items:center;gap:10px}
    .avatar{
      width:42px;height:42px;border-radius:50%;
      background:linear-gradient(135deg,var(--pink),#7f66ff);
      display:grid;place-items:center;font-weight:900;
    }
    .status{
      display:flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.25);
      font-size:12px;color:var(--mut);
      white-space:nowrap;
    }
    .dot{width:10px;height:10px;border-radius:50%;background:var(--bad);box-shadow:0 0 14px rgba(255,59,59,.35)}
    .dot.ok{background:var(--ok);box-shadow:0 0 14px rgba(44,255,115,.35)}
    h1{margin:10px 0 6px;font-size:28px}
    p{margin:0;color:var(--mut);line-height:1.5}
    .field{display:grid;gap:10px;margin-top:14px}
    input{
      width:100%; padding:13px 14px; border-radius:14px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.25);
      color:var(--txt); outline:none; font-size:15px;
    }
    input:focus{border-color:rgba(255,77,166,.55);box-shadow:0 0 0 3px rgba(255,77,166,.12)}
    button{
      border:none; cursor:pointer;
      padding:13px 14px; border-radius:14px;
      font-weight:900; color:white;
      background:linear-gradient(135deg,var(--pink),var(--pink2));
      box-shadow:0 10px 25px rgba(255,77,166,.22);
    }
    .mini{font-size:12px;color:var(--mut);margin-top:8px}
    .msg{font-size:13px;margin-top:10px;font-weight:800}
    .good{color:var(--ok)} .bad{color:var(--bad)}
    .hide{display:none !important;}
  </style>
</head>

<body>
  <div class="card">
    <div class="top">
      <div class="brand">
        <div class="avatar">S</div>
        <div>
          <div style="font-weight:950">Shuttumani üíó</div>
          <div style="font-size:12px;color:var(--mut)">Private chat</div>
        </div>
      </div>

      <div class="status">
        <div id="dot" class="dot"></div>
        <div id="stat">Locked</div>
      </div>
    </div>

    <h1>Unlock üîí</h1>
    <p>Enter our secret date to open.</p>

    <div class="field">
      <input id="lockInput" inputmode="numeric" maxlength="8" placeholder="01032025" />
      <button id="unlockBtn">Unlock</button>
    </div>

    <div class="mini">Hint: DDMMYYYY</div>
    <div id="msg" class="msg"></div>
    <!-- LOGIN PAGE -->
<section id="loginBox" class="glass panel grid hide">
  <div>
    <h1 class="h1">Login üíû</h1>
    <p class="p">Enter email and password to continue.</p>
  </div>

  <div class="field">
    <input id="email" placeholder="Email">
    <input id="pass" type="password" placeholder="Password">
    <button id="loginBtn" class="btn">Login</button>
  </div>

</section>
    <!-- CHAT PAGE -->
<section id="chatBox" class="glass hide">

  <div class="panel">
    <h2>Private Chat üí¨</h2>
  </div>

  <div id="msgs"></div>

  <div class="bar">
    <div class="barInner">
      <input id="msgInput" placeholder="Type message">
      <button id="sendBtn" class="btn">Send</button>
    </div>
  </div>

</section>
  </div>

  <script>
    type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
    signInWithEmailAndPassword,
    signOut
  } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

  import {
    getFirestore,
    doc, setDoc, onSnapshot,
    collection, addDoc,
    serverTimestamp,
    query, orderBy, limit,
    onSnapshot as onSnapQuery
  } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

  // ‚úÖ your firebase config (keep your own)
  const firebaseConfig = {
    apiKey: "AIzaSyDJ5nrd-sCZNvCsg3THxXhewT0cBzkDoCI",
    authDomain: "shuttumani-chat.firebaseapp.com",
    projectId: "shuttumani-chat",
    storageBucket: "shuttumani-chat.firebasestorage.app",
    messagingSenderId: "1033302224383",
    appId: "1:1033302224383:web:952bdfed407ab257cf0bca"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // ====== FIXED IDs ======
  const ROOM_ID = "our-room";
  const HER_UID = "SAy45xarKaXAL9gHFGGJkxLUHpq1"; // (her uid you gave)
  // =======================

  // UI
  const loginBox = document.getElementById("loginBox");
  const chatBox  = document.getElementById("chatBox");

  const emailEl  = document.getElementById("email");
  const passEl   = document.getElementById("pass");
  const loginBtn = document.getElementById("loginBtn");
  const loginMsg = document.getElementById("loginMsg");

  const logoutBtn = document.getElementById("logoutBtn");
  const whoLine   = document.getElementById("whoLine");

  const msgs     = document.getElementById("msgs");
  const msgInput = document.getElementById("msgInput");
  const sendBtn  = document.getElementById("sendBtn");

  const onlineDot  = document.getElementById("onlineDot");
  const onlineText = document.getElementById("onlineText");
  const lastSeenTag= document.getElementById("lastSeenTag");

  function showEl(el){ el.classList.remove("hide"); }
  function hideEl(el){ el.classList.add("hide"); }

  // ====== LOGIN BUTTON WORKING ======
  loginBtn.addEventListener("click", async () => {
    loginMsg.textContent = "Logging in‚Ä¶";
    try{
      await signInWithEmailAndPassword(auth, emailEl.value.trim(), passEl.value);
      loginMsg.textContent = "";
    }catch(e){
      console.log(e);
      loginMsg.textContent = "Login failed. Check email/password.";
    }
  });

  // logout
  logoutBtn.addEventListener("click", async () => {
    await signOut(auth);
  });

  // ====== CHAT SEND ======
  async function sendMsg(){
    const t = (msgInput.value || "").trim();
    if(!t) return;

    msgInput.value = "";

    await addDoc(collection(db, "rooms", ROOM_ID, "messages"), {
      text: t,
      email: auth.currentUser?.email || "unknown",
      createdAt: serverTimestamp()
    });
  }

  sendBtn.addEventListener("click", sendMsg);
  msgInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter") sendMsg(); });

  // ====== PRESENCE (online + last seen) ======
  let presenceTimer = null;

async function setMyPresence(online){
  const u = auth.currentUser;
  if(!u) return;

  await setDoc(doc(db, "presence", u.uid), {
    email: u.email,
    online,
    lastSeen: serverTimestamp()
  }, { merge:true });
}

function startPresenceHeartbeat(){
  // every 20 seconds update lastSeen + keep online true
  if(presenceTimer) clearInterval(presenceTimer);
  presenceTimer = setInterval(() => setMyPresence(true), 20000);
}

function stopPresenceHeartbeat(){
  if(presenceTimer) clearInterval(presenceTimer);
  presenceTimer = null;
}

  function setOnlineUI(isOnline, lastSeenDate){
    if(isOnline){
      onlineDot.classList.add("ok");
      onlineText.textContent = "She is online";
      lastSeenTag.textContent = "Last seen: now";
    }else{
      onlineDot.classList.remove("ok");
      onlineText.textContent = "She is offline";
      lastSeenTag.textContent = lastSeenDate ? ("Last seen: " + lastSeenDate.toLocaleString()) : "Last seen: ‚Äî";
    }
  }

  // ====== AUTH STATE: open chat after login ======
  let unsubMsgs = null;
  let unsubHerPresence = null;

  onAuthStateChanged(auth, async (user) => {
    if(!user){ 
      stopPresenceHeartbeat();
      // show login screen (lock already handled by Step 2)
      showEl(loginBox);
      hideEl(chatBox);
      hideEl(logoutBtn);

      whoLine.textContent = "Signed in‚Ä¶";
      msgs.innerHTML = "";
      onlineText.textContent = "Loading‚Ä¶";
      lastSeenTag.textContent = "Last seen: ‚Äî";
      onlineDot.classList.remove("ok");

      if(unsubMsgs) unsubMsgs();
      if(unsubHerPresence) unsubHerPresence();
      return;
    }

    // logged in -> show chat
    hideEl(loginBox);
    showEl(chatBox);
    showEl(logoutBtn);

    whoLine.textContent = "Signed in as: " + (user.email || "");

    // set me online
    await setMyPresence(true);

    // best-effort offline mark
    window.addEventListener("beforeunload", () => { setMyPresence(false); });

    // listen messages
    const qMsgs = query(
      collection(db, "rooms", ROOM_ID, "messages"),
      orderBy("createdAt", "asc"),
      limit(200)
    );

    if(unsubMsgs) unsubMsgs();
    unsubMsgs = onSnapQuery(qMsgs, (snap)=>{
      msgs.innerHTML = "";
      snap.forEach((d)=>{
        const m = d.data();
        const div = document.createElement("div");
        const mine = (m.email === user.email);
        div.className = "bubble" + (mine ? " me" : "");
        const dt = m.createdAt?.toDate ? m.createdAt.toDate() : null;

        div.innerHTML = `
          <div>${(m.text||"").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]))}</div>
          <div class="meta">${m.email || "unknown"} ‚Ä¢ ${dt ? dt.toLocaleString() : ""}</div>
        `;
        msgs.appendChild(div);
      });
      msgs.scrollTop = msgs.scrollHeight;
    });

    // listen HER presence (online + last seen)
    if(unsubHerPresence) unsubHerPresence();
    unsubHerPresence = onSnapshot(doc(db, "presence", HER_UID), (snap)=>{
      if(!snap.exists()){
        setOnlineUI(false, null);
        return;
      }
      const p = snap.data();
      const last = p.lastSeen?.toDate ? p.lastSeen.toDate() : null;
      setOnlineUI(!!p.online, last);
    });
  });

const SECRET_LOCK = "01032025";

// unlock button
document.getElementById("unlockBtn").onclick = function(){

  const entered = document.getElementById("lockInput").value.trim();

  if(entered === SECRET_LOCK){

    // hide lock
    document.getElementById("lockBox").classList.add("hide");

    // show login
    document.getElementById("loginBox").classList.remove("hide");

  }
  else{
    alert("Wrong date ‚ù§Ô∏è");
  }

};

    const input = document.getElementById("lockInput");
    const btn = document.getElementById("unlockBtn");
    const msg = document.getElementById("msg");
    const dot = document.getElementById("dot");
    const stat = document.getElementById("stat");

    function setLocked(){
      dot.classList.remove("ok");
      stat.textContent = "Locked";
    }
    function setUnlocked(){
      dot.classList.add("ok");
      stat.textContent = "Unlocked";
    }

    setLocked();

    btn.addEventListener("click", () => {
      const v = (input.value || "").trim();
      if (v === SECRET) {
        setUnlocked();
        msg.innerHTML = '<span class="good">‚úÖ Unlocked! (Next step: Login screen)</span>';
        localStorage.setItem("sh_unlocked", "1");
        // Step 2 will replace this message with real login UI.
      } else {
        setLocked();
        msg.innerHTML = '<span class="bad">‚ùå Wrong date. Try again.</span>';
        input.value = "";
        input.focus();
      }
    });

    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") btn.click();
    });
  </script>
</body>
</html>
